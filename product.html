<!doctype html>
<html lang="uz">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>KUKA HOME — Mahsulot</title>
  <link rel="stylesheet" href="style.css"/>
</head>
<body>
  <!-- header (sizdagi shapkani qo'ying) -->

  <main class="container">
    <section class="pdp" id="pdp">
      <div class="pdp-gallery" data-gallery>
        <div class="pdp-track"></div>
        <div class="pdp-thumbs"></div>
        <button class="pdp-nav left" data-gprev aria-label="prev">
          <svg width="22" height="22"><use href="assets/icons/ui.svg#i-arrow-left"></use></svg>
        </button>
        <button class="pdp-nav right" data-gnext aria-label="next">
          <svg width="22" height="22"><use href="assets/icons/ui.svg#i-arrow-right"></use></svg>
        </button>
      </div>

      <div class="pdp-info">
        <h1 class="pdp-title" id="pdpTitle">...</h1>
        <div class="pdp-price" id="pdpPrice"></div>

        <div class="pdp-actions">
          <button class="btn buy" id="pdpBuy">Savatga qo‘shish</button>
          <a class="btn ghost" id="pdpTg" target="_blank">Telegram orqali</a>
        </div>

        <div class="pdp-tabs">
          <button class="tab is-active" data-tab="desc">Tavsif</button>
          <button class="tab" data-tab="spec">Xarakteristika</button>
        </div>

        <div class="pdp-panel is-open" data-panel="desc" id="pdpDesc"></div>
        <div class="pdp-panel" data-panel="spec" id="pdpSpec"></div>
      </div>
    </section>
  </main>

  <!-- footer (sizdagi footer) -->

  <script src="store.js"></script>
  <script src="sheets.js"></script>
  <script src="ui.js"></script>
  <script>
    // ===== PDP logic (sheets.js dan productni topadi) =====
    const qs = new URLSearchParams(location.search);
    const id = qs.get('id');

    // sizning sheets.js dagi “getAllProducts()” ga moslab qo'ying:
    // getAllProducts().then(list => ...)
    async function boot(){
      const list = await window.getAllProducts?.() || [];
      const p = list.find(x => String(x.model).trim() === String(id).trim());
      if(!p){ document.getElementById('pdp').innerHTML = '<h2>Mahsulot topilmadi</h2>'; return; }

      document.getElementById('pdpTitle').textContent = p.model;
      document.getElementById('pdpPrice').textContent = formatSum(p.price);

      const images = [p.img1, p.img2, p.img3].filter(Boolean);
      initGallery(images);

      document.getElementById('pdpDesc').textContent = p.desc || '';
      document.getElementById('pdpSpec').textContent = p.spec || '';

      const buy = document.getElementById('pdpBuy');
      const isYes = String(p.available || '').toLowerCase() === 'yes';

      if(!isYes){
        buy.disabled = true;
        buy.classList.add('is-off');
        buy.textContent = "Mavjud emas";
      }

      buy.addEventListener('click', ()=>{
        if(buy.disabled) return;
        window.cartAdd?.(p);               // store.js dagi add
        window.flyToCart?.(document.querySelector('.pdp-track img')); // animatsiya
        window.toast?.("Savatga qo‘shildi ✅");
      });

      document.getElementById('pdpTg').href = `https://t.me/your_manager_username?text=${encodeURIComponent('Salom! '+p.model+' haqida ma’lumot kerak.')}`;
      initTabs();
    }

    function formatSum(v){
      const n = Number(String(v).replace(/[^\d]/g,'') || 0);
      return n.toLocaleString('ru-RU') + " so'm";
    }

    function initTabs(){
      const tabs = document.querySelectorAll('.tab');
      const panels = document.querySelectorAll('.pdp-panel');
      tabs.forEach(t=>{
        t.addEventListener('click', ()=>{
          tabs.forEach(x=>x.classList.remove('is-active'));
          t.classList.add('is-active');
          panels.forEach(p=>p.classList.remove('is-open'));
          document.querySelector(`[data-panel="${t.dataset.tab}"]`)?.classList.add('is-open');
        })
      })
    }

    function initGallery(images){
      const root = document.querySelector('[data-gallery]');
      const track = root.querySelector('.pdp-track');
      const thumbs = root.querySelector('.pdp-thumbs');
      let idx = 0;

      track.innerHTML = images.map(src=>`<img src="${src}" alt="" draggable="false">`).join('');
      thumbs.innerHTML = images.map((src,i)=>`<button class="thumb ${i===0?'is-active':''}" data-i="${i}"><img src="${src}" alt=""></button>`).join('');

      const imgs = Array.from(track.querySelectorAll('img'));
      function go(i){
        idx = (i+imgs.length)%imgs.length;
        track.style.transform = `translateX(-${idx*100}%)`;
        thumbs.querySelectorAll('.thumb').forEach(b=>b.classList.remove('is-active'));
        thumbs.querySelector(`[data-i="${idx}"]`)?.classList.add('is-active');
      }

      root.querySelector('[data-gprev]').addEventListener('click', ()=>go(idx-1));
      root.querySelector('[data-gnext]').addEventListener('click', ()=>go(idx+1));
      thumbs.addEventListener('click', (e)=>{
        const b = e.target.closest('.thumb'); if(!b) return;
        go(Number(b.dataset.i));
      });

      // swipe
      let s=0,d=0,down=false;
      root.addEventListener('pointerdown', (e)=>{ down=true; s=e.clientX; d=0; track.style.transition='none'; });
      root.addEventListener('pointermove', (e)=>{ if(!down) return; d=e.clientX-s; track.style.transform=`translateX(calc(-${idx*100}% + ${d}px))`;});
      root.addEventListener('pointerup', ()=>{ if(!down) return; down=false; track.style.transition=''; if(Math.abs(d)>60) go(idx+(d<0?1:-1)); else go(idx);});
      go(0);
    }

    boot();
  </script>
</body>
</html>
