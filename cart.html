<!doctype html>
<html lang="uz">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>KUKA HOME — Savat</title>
  <link rel="stylesheet" href="style.css"/>
</head>
<body>

<header class="header">
  <div class="container">
    <div class="midbar">
      <a href="index.html" class="brand">
        <img src="assets/logo.png" alt="KUKA HOME">
      </a>

      <a href="index.html" class="btn ghost">⬅ Ortga</a>

      <a href="cart.html" class="cartPill">
        Savat
        <span class="badge" id="cartBadge">0</span>
      </a>
    </div>
  </div>
</header>

<main class="container section">
  <div class="cartLayout">

    <!-- LEFT: Items -->
    <div>
      <h2 style="margin-top:0">Savat</h2>
      <div id="cartList"></div>
    </div>

    <!-- RIGHT: Checkout -->
    <div class="checkoutCard">
      <h3>Buyurtma berish</h3>

      <label class="muted">Telefon raqamingiz</label>
      <input id="orderPhone" placeholder="+998..." class="checkoutInput"/>

      <div class="paymentBlock">
        <div class="muted">To‘lov turi</div>
        <div class="paymentBtns">
          <button class="btn ghost" id="payCash">Naqd</button>
          <button class="btn ghost" id="payCard">Karta</button>
          <button class="btn ghost" disabled>Bo‘lib to‘lash</button>
        </div>
      </div>

      <div class="checkoutTotal">
        <span>Jami:</span>
        <b id="totalSum">0</b>
      </div>

      <button class="btn primary" id="orderSend" style="width:100%">
        Buyurtmani tasdiqlash
      </button>
    </div>

  </div>
</main>

<script src="store.js"></script>
<script src="sheets.js"></script>
<script src="ui.js"></script>

<script>
function renderCart(){
  const cart = getCartItems();
  const list = document.getElementById("cartList");

  if(cart.length === 0){
    list.innerHTML = `
      <div class="card" style="padding:30px;text-align:center">
        <p class="muted">Savat bo‘sh.</p>
        <a href="index.html" class="btn primary">Katalogga qaytish</a>
      </div>
    `;
    document.getElementById("totalSum").textContent = "0 so'm";
    return;
  }

  list.innerHTML = cart.map(item => `
    <div class="cartItem">
      <img src="${item.images?.[0] || 'assets/products/placeholder.jpg'}">

      <div class="cartInfo">
        <h4>${item.title}</h4>
        <div class="muted">${formatMoney(item.price)}</div>

        <div class="qtyRow">
          <button data-minus="${item.id}">−</button>
          <span>${item.qty}</span>
          <button data-plus="${item.id}">+</button>
        </div>
      </div>

      <button class="removeBtn" data-del="${item.id}">✕</button>
    </div>
  `).join("");

  document.getElementById("totalSum").textContent =
    formatMoney(getCartTotal());
}

document.addEventListener("click", e=>{
  const del = e.target.closest("[data-del]");
  const minus = e.target.closest("[data-minus]");
  const plus = e.target.closest("[data-plus]");

  if(del){
    removeFromCart(del.dataset.del);
    toast("O‘chirildi");
    renderCart();
  }

  if(minus){
    changeQty(minus.dataset.minus, -1);
    renderCart();
  }

  if(plus){
    changeQty(plus.dataset.plus, +1);
    renderCart();
  }
});

document.addEventListener("DOMContentLoaded", ()=>{
  updateCartBadge();
  renderCart();

  document.getElementById("orderSend").onclick = async ()=>{
    const phone = document.getElementById("orderPhone").value.trim();
    if(!phone) return toast("Telefon kiriting");

    const items = getCartItems();
    if(!items.length) return toast("Savat bo‘sh");

    const payload = {
      phone,
      items,
      total: getCartTotal(),
      ts: new Date().toISOString()
    };

    const r = await sendOrderToSheets(payload);
    if(r && r.ok !== false){
      toast("Buyurtma yuborildi ✅");
      clearCart();
      renderCart();
    }else{
      toast("Xatolik ❌");
    }
  };
});
</script>

</body>
</html>
