<!doctype html>
<html lang="uz">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>KUKA HOME â€” Savat</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>

<header class="header">
  <div class="container topbar">
    <div class="social">
      <a class="iconbtn" href="index.html">â¬…</a>
    </div>
    <div class="topnav">
      <a href="index.html" style="font-weight:900">KUKA HOME</a>
    </div>
    <div class="lang">
      <button id="langUz"><span class="flag">ğŸ‡ºğŸ‡¿</span> Oâ€˜zbekcha</button>
      <button id="langRu"><span class="flag">ğŸ‡·ğŸ‡º</span> Ğ ÑƒÑ</button>
      <button id="langEn"><span class="flag">ğŸ‡¬ğŸ‡§</span> EN</button>
    </div>
  </div>
</header>

<main class="container section" style="display:grid; grid-template-columns: 1.2fr .8fr; gap:18px">
  <div>
    <h2 data-i18n="cart">Savat</h2>
    <div id="cartList"></div>
  </div>

  <div class="card" style="padding:16px">
    <h3 style="margin:0 0 10px" data-i18n="order">Buyurtma berish</h3>
    <p class="muted" style="margin-top:0">Telefon raqamingizni kiriting. Buyurtma Google Sheetsâ€™ga tushadi.</p>

    <input id="orderPhone" placeholder="+998..." style="width:100%;padding:12px;border:1px solid var(--stroke);border-radius:14px;outline:none;margin:8px 0 10px">

    <button class="btn primary" id="orderSend" style="width:100%" data-i18n="confirm">Tasdiqlash</button>

    <div style="margin-top:14px">
      <p class="muted" style="margin:0 0 10px">Toâ€˜lov:</p>
      <div style="display:flex; gap:10px; flex-wrap:wrap">
        <button class="btn ghost" id="payCash">Naqd</button>
        <button class="btn ghost" id="payCard">Karta</button>
        <button class="btn ghost" id="paySplit">Boâ€˜lib toâ€˜lash</button>
      </div>
    </div>

    <div style="margin-top:14px">
      <b>Jami:</b> <span id="totalSum">0</span>
    </div>
  </div>
</main>

<button class="toTop" id="toTop" aria-label="Top">
  <svg viewBox="0 0 24 24"><path fill="white" d="M12 5l7 7-1.4 1.4L13 8.8V20h-2V8.8l-4.6 4.6L5 12l7-7z"/></svg>
</button>

<script src="i18n.js"></script>
<script src="store.js"></script>
<script src="sheets.js"></script>
<script src="ui.js"></script>
<script>
  function numFromPrice(p){
    // "1 260 000 so'm" -> 1260000
    if(!p) return 0;
    const n = p.toString().replace(/[^\d]/g,"");
    return Number(n||0);
  }
  function formatUZS(n){
    return n.toString().replace(/\B(?=(\d{3})+(?!\d))/g, " ") + " so'm";
  }

  function renderCart(){
    const cart = readCart();
    const list = document.getElementById("cartList");
    if(cart.length===0){
      list.innerHTML = `<p class="muted">Savat boâ€˜sh.</p>`;
      document.getElementById("totalSum").textContent = "0";
      return;
    }

    list.innerHTML = cart.map(item=>{
      const price = item.price_new?.trim() ? item.price_new : item.price_old;
      return `
        <div class="card" style="display:grid; grid-template-columns: 110px 1fr; gap:14px; padding:14px; margin-bottom:12px">
          <img src="${item.image||"assets/products/placeholder.jpg"}" style="width:110px;height:90px;object-fit:cover;border-radius:14px;border:1px solid var(--stroke)">
          <div>
            <div style="display:flex; justify-content:space-between; gap:10px">
              <div>
                <b>${item.model||""}</b>
                <div class="muted" style="margin-top:6px">${price||"Soâ€˜rov boâ€˜yicha"}</div>
              </div>
              <button class="btn ghost" data-del="${item.id}">ğŸ—‘</button>
            </div>

            <div style="display:flex; align-items:center; gap:10px; margin-top:12px">
              <button class="btn ghost" data-minus="${item.id}">âˆ’</button>
              <b>${item.qty}</b>
              <button class="btn ghost" data-plus="${item.id}">+</button>
            </div>
          </div>
        </div>
      `;
    }).join("");

    // total
    let total = 0;
    cart.forEach(i=>{
      const p = i.price_new?.trim() ? i.price_new : i.price_old;
      total += numFromPrice(p) * i.qty;
    });
    document.getElementById("totalSum").textContent = formatUZS(total);
  }

  document.addEventListener("click", (e)=>{
    const d = e.target.closest("[data-del]");
    const m = e.target.closest("[data-minus]");
    const p = e.target.closest("[data-plus]");
    if(d){ removeFromCart(d.dataset.del); renderCart(); }
    if(m){ changeQty(m.dataset.minus, -1); renderCart(); }
    if(p){ changeQty(p.dataset.plus, +1); renderCart(); }
  });

  document.addEventListener("DOMContentLoaded", ()=>{
    initLangButtons(); applyI18n(); updateCartBadge();
    initToTop();
    renderCart();

    document.getElementById("paySplit").onclick = ()=> alert(t("soon"));
    document.getElementById("payCash").onclick = ()=> alert("OK âœ…");
    document.getElementById("payCard").onclick = ()=> alert("OK âœ…");

    document.getElementById("orderSend").onclick = async ()=>{
      const phone = document.getElementById("orderPhone").value.trim();
      if(!phone) return alert("Telefon raqam kiriting.");
      const cart = readCart();
      if(cart.length===0) return alert("Savat boâ€˜sh.");

      const payload = {
        phone,
        items: cart,
        page: location.href,
        ts: new Date().toISOString()
      };

      const r = await sendOrderToSheets(payload);
      if(r && r.ok !== false){
        alert("Buyurtma yuborildi âœ…");
        writeCart([]);
        renderCart();
      }else{
        alert("Xatolik. Endpoint tekshiring.");
      }
    };
  });
</script>
</body>
</html>
